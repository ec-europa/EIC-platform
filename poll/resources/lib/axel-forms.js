/* ***** BEGIN LICENSE BLOCK *****
 *
 * Copyright (C) 2012 S. Sire
 *
 * This file contains files from the AXEL-FORMS extension to the Adaptable XML Editing Library (AXEL)
 * Version 0.2
 *
 * AXEL-FORMS is licensed by Oppidoc SARL 
 *
 * Web site : http://www.oppidoc.fr, https://bitbucket.org/ssire/axel-forms
 * 
 * Contributors(s) : S. Sire
 * 
 * ***** END LICENSE BLOCK ***** */
 (function(h){var i=0,k=0;var a={};var e={};var c={};var l={defaults:{},configure:function(m,n){this.defaults[m]=n},logError:function(n,m){h.error(n,m)},register:function(o,n,p){var m={factory:n};if(p){h.extend(m,p)}a[o]=m},getEditor:function(m){return e[m]},getCommand:function(n,o){var m=n,p=o,r=c[o],q=r?r[n]:undefined;return q||{execute:function(){alert("Command "+m+" not found on "+p)}}}};function b(m,n){xtiger.cross.log("debug","adding editor "+m);e[m]=n}function j(o,p){var n=$(o).attr("id")||("untitled"+(i++)),m=new a.transform.factory(n,o,p);xtiger.cross.log("debug","registering editor "+n);e[n]=m;return m}function f(q,p,r){var o=$(q).attr("data-target")||("untitled"+(k++)),s=$(q).attr("id"),n=a[p],m;if(n){if(n.check){if(h.command.getEditor(o)){if(q.disabled){q.disabled=false}m=new a[p].factory(o,q,r)}else{q.disabled=true;h.error("Missing or invalid data-target attribute in "+p+' command ("'+o+'")')}}else{m=new a[p].factory(o,q,r)}if(m&&s){if(!c[s]){c[s]={}}c[s][p]=m}}else{h.error('Attempt to create an unkown command "'+p+'"')}}function d(t,u,p){var o,w,n,m=u||t,r=p||u,v=[],s=[],q=[];n=u?"[data-template]":"* [data-template]";w=m;do{$(n,w).each(function(x,y){v.push(y)});w=u?w.nextSibling:undefined}while(w&&(w!==p)&&(r!=u));n="[data-command]";w=m;do{$(n,w).each(function(x,y){if($(y).attr("data-command")!=="transform"){s.push(y)}else{if(!$(y).attr("data-template")){v.push(y)}}});w=u?w.nextSibling:undefined}while(w&&(w!==p)&&(r!=u));if(l.defaults.bundlesPath){for(o=0;o<v.length;o++){q.push(j(v[o],t))}}else{if(v.length>0){h.error("Cannot start editing because AXEL bundles path is unspecified")}}for(o=0;o<s.length;o++){v=$(s[o]).attr("data-command").split(" ");for(w=0;w<v.length;w++){f(s[o],v[w],t)}}return q}h.command=l;h.command.install=d;h.command.addEditor=b;h.resolveUrl=function g(m,p){var o=m,n;if(m&&(m.length>2)){if(m.charAt(0)==="~"&&m.charAt(1)==="/"){if((window.location.href.charAt(window.location.href.length-1))!=="/"){o=window.location.href.split("#")[0]+"/"+m.substr(2)}else{o=m.substr(2)}}else{if(m.charAt(0)==="^"&&m.charAt(1)==="/"){o=($(p).closest("*[data-axel-base]").attr("data-axel-base")||"/")+m.substr(2)}}if(o.indexOf("$^")!==-1){n=window.location.href.split("#")[0].match(/([^\/]+)\/?$/);if(n){o=o.replace("$^",n[1])}}}return o};jQuery(function(){var n=$("script[data-bundles-path]"),o=n.attr("data-bundles-path"),m=n.attr("data-when"),p;if(o){l.configure("bundlesPath",o);h.filter.applyTo({optional:["input","choice"],event:"input"})}if(navigator.browserLanguage){p=navigator.browserLanguage}else{p=navigator.language}if(p){p=p.substr(0,2);if(xtiger.defaults.locales[p]){h.setLocale(p);xtiger.cross.log("debug","set lang to "+p)}}if("deferred"!==m){d(document)}})}($axel));(function(h){var a={};var j={getDocument:function(){return this._doc},getParam:function(k){return this._param[k]||this._defaults[k]},getVariable:function(){return this._variable}};var c={_installError:function(k){this.errScope=k.attr("data-error-scope")||undefined;this.errSel="[data-"+this.getName()+'-error="'+this.getVariable()+'"]'},toggleError:function(n,l){var k,m,o=this.getDocument();if(!this.errScope){k=$("body "+this.errSel,o)}else{if(l){m=$(l,o).closest(this.errScope);k=$(this.errSel,m.get(0))}}if(k){if(n){k.hide()}else{k.show()}}return n}};function d(n,m,l){var k=new Function();k.prototype=(function(o){var p=o;return{getName:function(){return p}}}(n));h.extend(k.prototype,j);if(m&&m.error){h.extend(k.prototype,c)}k.prototype.onInstall=l.onInstall;h.extend(k.prototype,l.methods,false,true);return k}function g(p,o,s,r){var q,l,t,m=r||".af-label",n=[],k=[];p.apply(function(B){var u=(B.getParam("required")==="true"),w=B.isValid,v=(B.getParam("required")!=="true")||B.isModified(),z=(!v)||(!B.isValid||B.isValid()),A=$(B.getHandle()),x=A.parents().children(m).first(),C,y;if(v&&u){A.removeClass("af-required");x.removeClass("af-required")}if(z&&w){A.removeClass("af-invalid");x.removeClass("af-invalid")}if((u||w)&&(!v||!z)){C=x.contents(":not(span)").text();y=C.lastIndexOf(":");if(y!=-1){C=C.substr(0,y)}C=$.trim(C);if(!v&&u){A.addClass("af-required");x.addClass("af-required");n.push(C)}else{if(w){A.addClass("af-invalid");x.addClass("af-invalid");k.push(C)}}}});if(o){l=$("#"+o,s).html("");if(n.length>0){l.append("<p>"+xtiger.util.getLocaleString("errFormRequired",{fields:n.join(", ")})+"</p>")}if(k.length>0){l.append("<p>"+xtiger.util.getLocaleString("errFormInvalid",{fields:k.join(", ")})+"</p>")}q=(n.length===0)&&(k.length===0);if(!q){l.addClass("af-validation-failed");t=$.Event("axel-validate-error",{required:n.length,invalid:k.length});l.triggerHandler(t)}else{l.removeClass("af-validation-failed")}}return q}function b(l,k){if(l){if(typeof l.isValid==="function"){l.isValid.extend(k)}else{l.isValid=function(n){var o=[n];var m=function(){var q,p=true;for(var q=0;q<o.length;q++){p=p&&o[q](this)}return p};m.extend=function(p){o.push(p)};return m}(k)}}else{xtiger.cross.log("error","attempt to set a validator function on an undefined editor")}}function i(n,m,o,q){var p={},l=d(n,m,q);h.extend(p,o);a[n]={name:n,options:m,defaults:p,klass:l}}function e(t,u,q){var n,o,m,s,l={},p=true;var r=u.attr("data-variable");if(r){m=t.defaults;for(n in m){if(m.hasOwnProperty(n)){s=u.attr("data-"+n);if(s){l[n]=s}else{if(m[n]===h.binding.REQUIRED){xtiger.cross.log("error",'Missing attribute "data-'+n+'" to install "'+t.name+'" binding');p=false;break}}}}if(p){o=new t.klass();o._doc=q;o._variable=r;o._defaults=m;o._param=l;if(t.options&&t.options.error){o._installError(u)}o.onInstall(u);return o}}else{xtiger.cross.log("error",'Missing attribute "data-variable" to install "'+t.name+'" binding')}}function f(o,k,n){var p=k||o,l=n||k,m=k?"[data-binding]":"body [data-binding]";do{$(m,p).each(function(q,u){var r,s=$(u),t=s.attr("data-binding").split(" ");for(r=0;r<t.length;r++){if(a[t[r]]){e(a[t[r]],s,o)}else{xtiger.cross.log("error",'unregistered binding "'+t[r]+'"')}}});p=k?p.nextSibling:undefined}while(p&&(p!==n)&&(l!=k))}h.binding=h.binding||{};h.binding.list=function(){var k,l=[];for(k in a){l.push(k)}return l};h.binding.register=i;h.binding.install=f;h.binding.validate=g;h.binding.setValidation=b;h.binding.REQUIRED=1}($axel));(function(a){var b={getCommand:function(h){var g,i,c,d={xhr:h};if(h.responseXML){d.doc=h.responseXML}else{c=h.getResponseHeader("Content-Type");if(a.oppidum.checkJSON(c)){try{d.json=JSON.parse(h.responseText)}catch(f){}}else{i=xtiger.cross.makeDOMParser();try{d.doc=i.parseFromString(h.responseText,"text/xml")}catch(f){}}}return d},filterRedirection:function(d){var e=d.xhr&&d.xhr.getResponseHeader("Location"),c=true;if(e){window.location.href=e;c=false}return c},handleMessage:function(c){var d;if(c.doc){d=$("success > message",c.doc).text()}else{if(c.json){d=c.json.message?c.json.message["#text"]:'missing "message" element in response'}else{d=xhr.responseText}}if(d){alert(d)}},handleForward:function(e){var g,f,d,c;if(e.doc){d=$("success > forward",e.doc);g=d.attr("command");f=d.text()}if(g&&f){c={synthetic:true,command:e};a.command.getCommand(g,f).execute(c)}},checkJSON:function(d){var c="application/json";return(typeof d==="string")&&(d.slice(0,c.length)===c)},unmarshalMessage:function(d){var c=d.responseXML?$("success > message",d.responseXML).text():d.responseText;return c},unmarshalPayload:function(e){var f=e.responseText.indexOf("<payload>"),c,d=e.responseText;if(-1!==f){c=e.responseText.indexOf("</payload>");if(-1!==c){d=e.responseText.substr(f+9,c-f-9)}}return d},isResponseAnOppidumError:function(g){var d=g.getResponseHeader("Content-Type"),c=false;if(g.responseXML){c=$("error > message",g.responseXML).size()>0}else{if(a.oppidum.checkJSON(d)){try{c=JSON.parse(g.responseText).message!==undefined}catch(f){}}}return c},getOppidumErrorMsg:function(g){var d=g.getResponseHeader("Content-Type"),c;if(g.responseXML){c=$("error > message",g.responseXML).text()}else{if(a.oppidum.checkJSON(d)){try{c=JSON.parse(g.responseText).message["#text"]}catch(f){}}else{c=g.responseText}}return c||g.status},getExistErrorMsg:function(h){var g=h.responseText,d=h.status;var f="Error ! Result code : "+d;var e="";var c=g.match("<title>(.*)</title>","m");if(c){e="\n"+c[1]}c=g.match("<h2>(.*)</h2>","m");if(c){e=e+"\n"+c[1]}else{if($("div.message",h.responseXML).size()>0){e=e+"\n"+$("div.message",h.responseXML).get(0).textContent;if($("div.description",h.responseXML).size()>0){e=e+"\n"+$("div.description",h.responseXML).get(0).textContent}}}return f+e},parseError:function(i,c,f,d){var h,g;if(c==="timeout"){g=xtiger.util.getLocaleString("errServerTimeOut")}else{if(i.status===409){h=i.getResponseHeader("Location");if(h){window.location.href=h;g=xtiger.util.getLocaleString("msgRedirect")}else{g=a.oppidum.getOppidumErrorMsg(i)}}else{if(a.oppidum.isResponseAnOppidumError(i)){g=a.oppidum.getOppidumErrorMsg(i)}else{if(i.responseText.search("Error</title>")!==-1){g=a.oppidum.getExistErrorMsg(i)}else{if(f&&(typeof f==="string")){g=xtiger.util.getLocaleString("errException",{e:{message:f},status:i.status})}else{if(f){g=xtiger.util.getLocaleString("errException",{e:f,status:i.status})}else{if(d){g=xtiger.util.getLocaleString("errLoadDocumentStatus",{url:d,xhr:i})}else{if(i.responseText!==""){g=i.responseText}else{g=xtiger.util.getLocaleString("errLoadDocumentStatus",{xhr:i})}}}}}}}}return g}};xtiger.registry.registerFactory("protocol.upload",{getInstance:function(c){return{decode_success:function(d){return(-1!==d.responseText.indexOf("<payload"))?a.oppidum.unmarshalPayload(d):a.oppidum.unmarshalMessage(d)},decode_error:function(d){return a.oppidum.parseError(d,d.status)}}}});a.oppidum=b}($axel));(function(a){var b=(function(){function e(g){var f;if(g.indexOf("\\ ")===-1){return g.split(" ")}else{f=g.replace(/\\ /g,"&nbsp;");return xtiger.util.array_map(f.split(" "),function(h){return h.replace(/&nbsp;/g," ")})}}function c(n,r,k){var h,g,s,m=n.getHandle(),q=n.getDocument(),p=n.getParam("multiple")==="yes"?"checkbox":"radio",j=n.getParam("noedit")==="true"?'disabled="true" ':"",f=n.getUniqueKey(),l=n.getParam("appearance")==="full";for(h=0;h<r.length;h++){if(l){$(m).append("<li><label><input "+j+'type="'+p+'" value="'+r[h]+'" name ="'+f+'"/>'+k[h]+"</label></li>")}else{g=xtdom.createElement(q,"option");s=xtdom.createTextNode(q,k[h]);xtdom.setAttribute(g,"value",r[h]);if(n.getParam("noedit")==="true"){xtdom.setAttribute(g,"disabled",true)}g.appendChild(s);m.appendChild(g)}}}function d(f,g){var h=true;if(!f){if(typeof g==="string"){h=g!==f}else{if(!g||((g.length===1)&&!g[0])){h=false}}}else{h=g!==f}return h}return{onGenerate:function(i,h,f){var g;if(this.getParam("appearance")==="full"){g=xtdom.createElement(f,"ul")}else{g=xtdom.createElement(f,"select")}xtdom.addClassName(g,"axel-choice");i.appendChild(g);return g},onInit:function(i,g,h){var f=this.getParam("values");if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}if(this.getParam("multiple")==="yes"){$(this._handle).attr("multiple","multiple")}if(!h){c(this,this.getParam("values"),this.getParam("i18n"))}},onAwake:function(){var h=this,f=this.getDefaultData(),g=this.getParam("placeholder");if((this.getParam("appearance")!=="full")&&(g||(!f))){g=g||"";$(this._handle).prepend('<option class="axel-choice-placeholder" selected="selected" value="">'+(g||"")+"</option>");if(!f){this._param.values.splice(0,0,g);if(this._param.i18n!==this._param.values){this._param.i18n.splice(0,0,g)}if(g){$(this._handle).addClass("axel-choice-placeholder")}}}xtdom.addEventListener(this._handle,"change",function(i,j){if(!(j&&j.synthetic)){if(h.getParam("appearance")==="full"){var k=[];$("input",h.getHandle()).each(function(l,m){if(m.checked){k.push($(m).val())}});h.update(k)}else{h.update($(xtdom.getEventTarget(i)).val())}}},true);this._setData(f)},onLoad:function(l,k){var j,g,i,f,h;if(k.isEmpty(l)){this.clear(false)}else{f=this.getParam("xvalue");g=this.getDefaultData();if(f){j=[];i=k.getVectorFor(f,l);while(i!==-1){h=k.getDataFor(i);if(h){j.push(h)}i=k.getVectorFor(f,l)}this._setData(j.length>0?j:"")}else{h=k.getDataFor(l);if(typeof h!=="string"){h=""}j=(h||g).split(",");this._setData(j)}this.set(false);this.setModified(d(g,j))}},onSave:function(g){var f,j,h;if((!this.isOptional())||this.isSet()){if(this._data&&(this._data!==this.getParam("placeholder"))){f=this.getParam("xvalue");if(f){if(typeof this._data==="string"){g.openTag(f);g.write(this._data);g.closeTag(f)}else{for(h=0;h<this._data.length;h++){if(this._data[h]!==""){g.openTag(f);g.write(this._data[h]);g.closeTag(f)}}}}else{g.write(this._data.toString().replace(/^,/,""))}}}else{g.discardNodeIfEmpty()}},api:{_parseFromTemplate:function(h){var i,g;this._param={};xtiger.util.decodeParameters(h.getAttribute("param"),this._param);g=xtdom.extractDefaultContentXT(h);i=h.getAttribute("option");this._option=i?i.toLowerCase():null;var f=h.getAttribute("values"),l=h.getAttribute("i18n"),k=f?e(f):["undefined"],j=l?e(l):undefined;this._param.values=k;this._param.i18n=j||k;this._content=g||""},isFocusable:function(){return true},focus:function(){}},methods:{_setData:function(g,h){var f;if(this.getParam("appearance")!=="full"){if(!g&&(this.getParam("placeholder"))){$(this.getHandle()).addClass("axel-choice-placeholder")}else{$(this.getHandle()).removeClass("axel-choice-placeholder")}}this._data=g||"";if(!h){if(this.getParam("appearance")==="full"){f=typeof this._data==="string"?[this._data]:this._data;$("input",this.getHandle()).each(function(j,k){if($.inArray($(k).val(),f)>-1){k.checked=true;xtdom.removeClassName(k.parentNode,"axel-choice-unset")}else{k.checked=false;xtdom.addClassName(k.parentNode,"axel-choice-unset")}})}else{$(this.getHandle()).val(g)}}},dump:function(){return this._data},update:function(f){var g=d(this.getDefaultData(),f);this.setModified(g);this._setData(f,true);this.set(g)},clear:function(f){this._setData(this.getDefaultData());if(this.isOptional()){this.unset(f)}}}}}());a.plugin.register("choice",{filterable:true,optional:true},{choice:"value"},b);a.filter.applyTo({event:["choice"]})}($axel));(function(m){var n={};var a={};var j=function j(p,q){if(p){if(!n[p]){n[p]={}}n[p][q]=true}};var b=function b(p,r){var q=false;if(p){if(n[p]&&n[p][r]){delete n[p][r];q=true}}return q};var l=function(p){var q=p.getParam("date_format");return xtiger.util.date.convertDate(p,$.datepicker.formatDate($.datepicker[q]||q,new Date()),"date_format","date_region")};var d=function(r,q){var s=parseInt(q),p=((s===0)||(isNaN(s)))?1:s;if(a[r]===undefined){a[r]=0}else{a[r]+=1}return Math.floor(a[r]/p)};var c=function(p,q){var r;if(p.length>1){q.openTag("Block");while(r=p.shift()){q.openTag("Line");q.write(r);q.closeTag("Line")}q.closeTag("Block")}else{if(1===p.length){q.openTag("Text");q.write(p.pop());q.closeTag("Text")}}};var i=function(q){var r=q.firstChild,p=false;while(r){if(r.nodeType===xtdom.ELEMENT_NODE&&r.firstChild){p=true;break}r=r.nextSibling}return p};var e=function(r,q){var p;if(r==="normal"){p=$.trim(q).replace(/((\r\n|\n|\r)+)/gm,"$2$2").replace(/(\r\n|\n|\r)\s+(\r\n|\n|\r)/gm,"$1$2")}else{if(r==="enhanced"){p=$.trim(q).replace(/((\r\n|\n|\r){2,})/gm,"$2$2").replace(/(\r\n|\n|\r)\s+(\r\n|\n|\r)/gm,"$1$2")}else{p=$.trim(q)}}return p};var o={subscribe:function(p){var r=this;var q=function(s){if(!r.isEditing()){r.startEditing(s)}xtdom.stopPropagation(s);xtdom.preventDefault(s)};if(this.isEditable){xtdom.addEventListener(p,"focus",q,true);xtdom.addEventListener(p,"mouseup",function(s){xtdom.stopPropagation(s);xtdom.preventDefault(s)},true)}},isFocusable:function(){return(this.isEditable&&((!this._editor.isOptional())||this._editor.isSet()))},isEditing:function(){return this._isEditing},doKeyDown:function(p){},doKeyUp:function(p){},focus:function(){this._editor.getHandle().focus();this.startEditing()},unfocus:function(){this.stopEditing()},cancelEditing:function(){this._editor.getHandle().value=this._legacy;this.stopEditing(true,false)},clear:function(){this._editor.getHandle().value=this.defaultData},update:function(p){if(p===this._legacy){return}if(p.search(/\S/)===-1||(p===this._defaultData)){this._editor.clear(true)}else{this._editor.setModified(p!==this.defaultData);this._editor.set(true)}}};var h=function(v,p,q){var u=v.getHandle(),s="number"!==p?p:"text",r;this._editor=v;this.isEditable=!v.getParam("noedit");this.defaultData=q||"";xtdom.setAttribute(u,"type",s);if(r=v.getParam("size")){xtdom.setAttribute(u,"size",r)}u.value=this.defaultData};h.prototype={awake:function(){var p=this._editor.getHandle();var q=this;this.subscribe(p);if(this.isEditable){xtdom.addEventListener(p,"blur",function(r){if(q.isEditing()){q.stopEditing(false,true)}},true)}},load:function(w,u){var r,v,s;if(w!==-1){s=this._editor.getParam("multilines");if((s==="normal")||(s==="enhanced")){if(i(w[0])){var t=w[0].firstChild,q,p="";while(t){if(t.nodeType===xtdom.ELEMENT_NODE&&t.firstChild){if("Text"===t.nodeName){p=p+t.firstChild.nodeValue+"\n\n"}else{if("Block"===t.nodeName){q=t.firstChild;while(q){if(q.nodeType===xtdom.ELEMENT_NODE&&q.firstChild){p=p+q.firstChild.nodeValue+"\n"}q=q.nextSibling}p=p+"\n"}}}t=t.nextSibling}r=p}else{r=e(s,u.getDataFor(w))}}else{r=u.getDataFor(w)}v=this._editor.getDefaultData();this._editor.getHandle().value=r||v||"";this._editor.setModified(r!==v);this._editor.set(false)}else{this._editor.clear(false)}},save:function(q){var u=$.trim(this._editor.getHandle().value),t,r;var s=function(w,v){if(v.length>0){q.openTag("Text");q.write(v);q.closeTag("Text")}};var p=function(x,w){var v=x.charCodeAt(1);if((v===10)||(v===13)){c(t,q);t=[]}if(w.length>0){t.push(w)}};if(u){multi=this._editor.getParam("multilines");if(multi){r=new RegExp("[\n\r]{0,}(.*)","g");if("normal"===multi){u.replace(r,s)}else{t=[];u.replace(r,p);c(t,q)}}else{if("number"===this._editor.getParam("type")){q.write(u.replace(",","."))}else{q.write(u)}}}},startEditing:function(q){var p,r=xtiger.session(this._editor.getDocument()).load("keyboard");if(!this._isEditing){p=this._editor.getHandle();this._legacy=p.value;this._isEditing=true;this.kbdHandlers=r.register(this,p);r.grab(this,this._editor);if(this._editor.getParam("multilines")){r.enableRC(true)}if(!this._editor.isModified()){xtdom.focusAndSelect(p)}}},stopEditing:function(p,t){var q,s,r;if(this._isEditing){q=this._editor.getHandle();s=xtiger.session(this._editor.getDocument()).load("keyboard");this._isEditing=false;s.unregister(this,this.kbdHandlers,q);s.release(this,this._editor);if("normal"===this._editor.getParam("multilines")){s.disableRC()}if(!p){r=this._editor.getParam("multilines");q.value=e(r,q.value);this._editor.update(q.value)}if((!t)&&(q.blur)){q.blur()}}}};var k=function(r,p,q){xtdom.setAttribute(r.getHandle(),"type","text");this._editor=r;this.isEditable=!r.getParam("noedit");this.defaultData=q||"";this.dpDone=false};k.prototype={lazyInit:function(q){var p,r=this;if($.datepicker){$(q).on("keydown",function(s){if(s.keyCode===$.ui.keyCode.ESCAPE){r.onEscape()}xtdom.stopPropagation(s)});this.jhandle=$(q).datepicker({onClose:function(){r.onClose()}})}else{alert('datepicker jQuery plugin needed for "date" input field !')}this.dpDone=true},awake:function(){var p=this._editor.getHandle();this.subscribe(p);if(this.defaultData==="today"){p.value=this.defaultData=$.datepicker?l(this._editor):new Date()}else{p.value=xtiger.util.date.convertDate(this._editor,this.defaultData,"date_format","date_region")}this.model=p.value;if(!this._editor.getParam("size")){xtdom.setAttribute(p,"size",8)}},onEscape:function(p){this.escape=true},onClose:function(){this.stopEditing(this.escape);this.escape=false},startEditing:function(s){var q,p,t,r;xtiger.util.date.setRegion(this._editor.getParam("date_region"));if(!this.dpDone){r=this._editor.getHandle();this.lazyInit(r);if(this.jhandle){q=this._editor.getParam("minDate");p=this._editor.getParam("maxDate");t=this._editor.getParam("beforeShow");if(q){q=(q==="today")?l(this._editor):xtiger.util.date.convertDate(this._editor,q,"date_format","date_region");this.jhandle.datepicker("option","minDate",q)}if(p){p=(p==="today")?l(this._editor):xtiger.util.date.convertDate(this._editor,p,"date_format","date_region");this.jhandle.datepicker("option","maxDate",p)}if(t){this.jhandle.datepicker("option","beforeShow",t)}$(r).datepicker("show")}}},stopEditing:function(p){var q=this._editor.getHandle();val=q.value;if(val.search(/\S/)===-1){val=""}if(val&&((val.length!==10)||p)){q.value=this.model}else{this._editor.update(val);this.model=q.value}},load:function(t,r){var q,s,p=this._editor.getHandle();if(t!==-1){q=r.getDataFor(t);q=q?($.datepicker?xtiger.util.date.convertDate(this._editor,q,"date_format","date_region"):q):null;s=this.defaultData;p.value=q||s||"";this._editor.setModified(q!==s);this._editor.set(false)}else{this.clear(false)}this.model=p.value},save:function(p){var q=this._editor.getHandle().value;if(q){q=$.datepicker?xtiger.util.date.convertDate(this._editor,q,"date_region","date_format"):q;p.write(q)}}};var g=function(u,p,s){var t=u.getHandle(),r=u.getParam("name"),q=u.getParam("cardinality"),v=u.getParam("checked");this._editor=u;this._type=p;if(r||(p==="radio")){if(q){s=d(r||"void",q).toString()}r=(r||"").concat(s||"");xtdom.setAttribute(t,"name",r)}if(v){if(v===u.getParam("value")){t.checked=true}else{j(r,v)}}else{if(b(r,u.getParam("value"))){t.checked=true}}if(u.getParam("noedit")==="true"){xtdom.addClassName(t,"axel-input-unset")}};g.prototype={awake:function(){var p=this._editor.getHandle();var q=this;xtdom.addEventListener(p,"click",function(r){if(q._editor.getHandle().checked){q._editor.update(q._editor.getParam("value"))}else{q._editor.update("")}},true)},isFocusable:function(){return true},load:function(v,u){var t,q=this._editor.getHandle(),p=false,s=this._editor.getParam("value"),r;if(-1!==v){t=u.getDataFor(v);p=(t===s);if(!p){name=this._editor.getParam("name");p=b(name,s);j(name,t)}if(p){if(!q.checked){q.checked=true;this._editor.set(false);if(this._editor.getParam("noedit")==="true"){xtdom.removeClassName(q,"axel-input-unset")}}}else{this._editor.clear(false)}}else{r=this._editor.getParam("checked");if(r){if(r===s){p=true}else{name=this._editor.getParam("name");j(name,r)}}else{name=this._editor.getParam("name");p=b(name,s)}if(p){if(!q.checked){q.checked=true;this._editor.set(false);if(this._editor.getParam("noedit")==="true"){xtdom.removeClassName(q,"axel-input-unset")}}}else{this._editor.clear(false)}}},save:function(p){var q=this._editor;if(q.getHandle().checked&&(q.getParam("noxml")!=="true")){p.write(this._editor.getParam("value"))}else{p.discardNodeIfEmpty()}},update:function(p){},clear:function(){var p=this._editor.getHandle();if(this._editor.getParam("noedit")==="true"){xtdom.addClassName(p,"axel-input-unset")}p.checked=false},focus:function(){this._editor.getHandle().focus()},unfocus:function(){}};var f={onGenerate:function(u,s,r){var t=s.getAttribute("param"),q=(!t||(t.indexOf("type=textarea")===-1))?"input":"textarea",p=xtdom.createElement(r,q);if(t){if(t.indexOf("type=radio")!==-1){xtdom.setAttribute(p,"type","radio")}else{if(t.indexOf("type=checkbox")!==-1){xtdom.setAttribute(p,"type","checkbox")}}}if(this.getParam("noedit")==="true"){p.disabled=true}u.appendChild(p);return p},onInit:function(t,p,r){var q,s;q=this.getParam("type");if((q==="text")||(q==="number")||(q==="password")||(q==="textarea")){this._delegate=new h(this,q,t)}else{if((q==="radio")||(q==="checkbox")){this._delegate=new g(this,q,r?r.getClockCount():undefined)}else{if(q==="date"){this._delegate=new k(this,q,t)}else{xtdom.addClassName(this._handle,"axel-generator-error");xtdom.setAttribute(this._handle,"readonly","1");xtdom.setAttribute(this._handle,"value",'ERROR: type "'+q+'" not recognized by plugin "input"');alert('Form generation failed : fatal error in "input" plugin declaration')}}}if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}},onAwake:function(){this._delegate.awake()},onLoad:function(q,p){this._delegate.load(q,p)},onSave:function(p){if(($(this.getHandle()).attr("disabled")==="disabled")||(this.isOptional()&&!this.isSet())){p.discardNodeIfEmpty()}else{this._delegate.save(p)}},api:{isFocusable:function(){return this._delegate.isFocusable()},focus:function(){if(this._delegate.focus){this._delegate.focus()}},unfocus:function(){if(this._delegate.focus){this._delegate.unfocus()}}},methods:{update:function(p){this._delegate.update(p)},clear:function(p){this._delegate.clear();this.setModified(false);if(this.isOptional()&&this.isSet()){this.unset(p)}},set:function(p){if(p){if(!this.getParam("noedit")){xtiger.editor.Repeat.autoSelectRepeatIter(this.getHandle())}xtdom.removeClassName(this._handle,"axel-repeat-unset")}if(!this._isOptionSet){this._isOptionSet=true;if(this._isOptional){this._handle.disabled=false;this._optCheckBox.checked=true}}},unset:function(p){if(this._isOptionSet){this._isOptionSet=false;if(this._isOptional){this._handle.disabled=true;this._optCheckBox.checked=false}}}}};m.extend(h.prototype,o);m.extend(k.prototype,o);m.plugin.register("input",{filterable:true,optional:true},{type:"text",date_region:"fr",date_format:"ISO_8601"},f)}($axel));(function(a){var b={onGenerate:function(f,e,c){var d=xtdom.createElement(c,"div");xtdom.addClassName(d,"af-html");f.appendChild(d);return d},onInit:function(e,c,d){if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}},onAwake:function(){},onLoad:function(f,e){var c,d;if(e.isEmpty(f)){$(this.getHandle()).html("")}else{d=$(this.getHandle());d.html("");for(c=1;c<f.length;c++){d.append(f[c])}}},onSave:function(c){c.write("HTML BLOB")},api:{},methods:{}};a.plugin.register("html",{filterable:false,optional:false},{key:"value"},b)}($axel));(function(a){var b={onInstall:function(d){var e=d.attr("data-pattern"),c,f;this.re=new RegExp(this.getParam("regexp")||"");this.editor=a(d);this.spec=d;d.bind("axel-update",$.proxy(this.checkRegexp,this));if(e){d.find("input").attr("pattern",e)}a.binding.setValidation(this.editor.get(0),$.proxy(this.validate,this))},methods:{checkRegexp:function(){var g=this.re.test(this.editor.text()),f,d,i=this.getDocument(),c=this.spec.get(0),e=this.spec.attr("data-valid-class"),h=this.spec.attr("data-invalid-class");if(e||h){if(!this.errScope){d=$("body "+this.spec.attr("data-label-selector"),i)}else{f=$(c,i).closest(this.errScope);d=$(this.spec.attr("data-label-selector"),f.get(0))}if(e){g?d.addClass(e):d.removeClass(e)}if(h){g?d.removeClass(h):d.addClass(h)}}return this.toggleError(g,this.editor.get(0).getHandle(true))},validate:function(){var c=this.checkRegexp();return(this.spec.attr("data-validation")==="off")||c}}};a.binding.register("regexp",{error:true},{regexp:a.binding.REQUIRED},b)}($axel));(function(b){var a={onInstall:function(c){this.editors=b(c);this.handle=c.get(0);if(this.handle.xttPrimitiveEditor){xtiger.cross.log("error",'Failed attempt to attach a "required" binding directly onto a primitive editor')}else{this.handle.xttPrimitiveEditor=this}},methods:{isModified:function(){var c=(this.editors.text()!=="");return c},isFocusable:function(){var c=this.editors.get(1);return(c&&(c!==this))?c.isFocusable():false},focus:function(){var c=this.editors.get(0);if(c){this.editors.get(0).focus()}},unfocus:function(){},can:function(c){return false},getHandle:function(){return this.handle},onInit:function(e,c,d){},onAwake:function(){},load:function(d,c){},save:function(c){}}};b.binding.register("required",{error:true},{required:"true"},a)}($axel));(function(){function a(c,d,e){var b=$(d);this.doc=e;this.key=c;this.spec=b;if(b.attr("data-command")!=="transform"){this.transform();this.implicit=true}else{this.implicit=false}this.defaultTpl=this.spec.attr("data-template");this.defaultData=this.spec.attr("data-src")||"";this.ready=false}a.prototype={getDefaultTemplate:function(){return this.defaultTpl},getDefaultSrc:function(){return this.defaultData},attr:function(b){if(arguments.length>1){return this.spec.attr(b,arguments[1])}else{return this.spec.attr(b)}},transform:function(c,b){var e,h,d,f=c||this.spec.attr("data-template"),g=b||this.spec.attr("data-src");if((f===this.spec.attr("data-template"))&&this.ready){this.reset()}else{if(f){if(f!=="#"){e=f.substring(f.lastIndexOf("/")+1);if(e.indexOf("?")!==-1){e=e.substring(0,e.indexOf("?"))}}d={bundlesPath:$axel.command.defaults.bundlesPath,enableTabGroupNavigation:true};h=(f==="#")?$axel(this.spec).transform(d):$axel(this.spec).transform($axel.resolveUrl(f,this.spec.get(0)),d);if(g){h.load($axel.resolveUrl(g,this.spec.get(0)));this.spec.attr("data-src",g)}if(this.spec.attr("data-cancel")){$(window).bind("unload",$.proxy(this,"reportCancel"))}if(h.transformed()){if(!this.implicit){$axel.binding.install(this.doc,this.spec.get(0),this.spec.get(0));$axel.command.install(this.doc,this.spec.get(0).firstChild,this.spec.get(0).lastChild)}this.spec.attr("data-template",f);this.spec.addClass("edition").addClass(e);this.ready=true}else{this.ready=false}}else{$axel.error('Missing data-template attribute to generate the editor "'+this.key+'"')}}},reset:function(c){var b;if(c&&this.defaultTpl&&(this.defaultTpl!==this.spec.attr("data-template"))){this.attr("data-src",this.defaultData);this.transform($axel.resolveUrl(this.defaultTpl,this.spec.get(0)))}else{b=this.spec.attr("data-src");if(b){$axel(this.spec).load($axel.resolveUrl(b,this.spec.get(0)))}else{$axel(this.spec).load("<Reset/>")}$('*[class*="af-invalid"]',this.spec.get(0)).removeClass("af-invalid");$('*[class*="af-required"]',this.spec.get(0)).removeClass("af-required")}},reload:function(){var b=this.spec.attr("data-src");if(b){$axel(this.spec).load($axel.resolveUrl(b,this.spec.get(0)))}},trigger:function(c,d,b){this.spec.triggerHandler(c,[this,d,b])},serializeData:function(){return $axel(this.spec).xml()},reportCancel:function(b){if(!this.hasBeenSaved){$.ajax({url:this.spec.attr("data-cancel"),data:{transaction:this.spec.attr("data-transaction")},type:"GET",async:false})}}};$axel.command.register("transform",a,{check:false})}());(function(){function a(b,c){this.key=b;$(c).bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(d){var b,c=$axel.command.getEditor(this.key);if(c){c.reset();b=c.attr("data-validation-output");if(b){$("#"+b).removeClass("af-validation-failed")}}}};$axel.command.register("reset",a,{check:true})}());(function(){function a(b,c,d){this.doc=d||document;this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype=(function(){function f(i,k){var j;if(/all|swap|append|prepend/.test(i)){j=$axel.oppidum.unmarshalPayload(k);fnode=$("#"+this.spec.attr("data-replace-target"));if(fnode.length>0){if(i.indexOf("all")!==-1){fnode.replaceWith(j)}else{if(i.indexOf("swap")!==-1){this.swap=$(j);fnode.after(this.swap);fnode.hide();this.fragment=fnode;$('button[data-command="continue"]',this.swap).bind("click",$.proxy(c,this));$('button[data-command="reset"]',this.swap).bind("click",$.proxy(g,this))}else{if(i.indexOf("append")!==-1){fnode.append(j)}else{if(i.indexOf("prepend")!==-1){fnode.prepend(j)}}}}}else{xtiger.cross.log("error",'missing "data-replace-target" attribute to report "save" command success')}}}function c(){this.swap.remove();this.fragment.show()}function g(){var i=$axel.command.getEditor(this.key);if(i){i.reset();this.swap.remove();this.fragment.show()}else{$axel.error(xtiger.util.getLocaleString("editorNotFound"))}}function e(k,l,q,p){var o,i,m,n,j;if((q.status===202)&&p){n=confirm($("success > message",q.responseXML).text());if(p.url.indexOf("?")!==-1){m=p.url+"&_confirmed=1"}else{m=p.url+"?_confirmed=1"}if(n){$.ajax({url:m,type:p.method,data:p.payload,cache:false,timeout:50000,dataType:"xml",contentType:"application/xml; charset=UTF-8",success:$.proxy(e,this),error:$.proxy(d,this)});return}else{$axel.command.getEditor(this.key).trigger("axel-save-cancel",this,q)}}else{if((q.status===201)||(q.status===200)){j=$axel.oppidum.getCommand(q);if($axel.oppidum.filterRedirection(j)){$axel.oppidum.handleMessage(j);o=this.spec.attr("data-replace-type")||"all";f.call(this,o,q);$axel.command.getEditor(this.key).trigger("axel-save-done",this,q);if(o.indexOf("event")!==-1){m=this.spec.attr("data-event-target");if(m){m=$axel.command.getEditor(m);if(m){m.trigger("axel-save-done",this,q)}}}}}else{$axel.error(xtiger.util.getLocaleString("errServerResponse",{xhr:q}));$axel.command.getEditor(this.key).trigger("axel-save-error",this,q)}}h(this);if(j){$axel.oppidum.handleForward(j)}}function d(m,j,k){var l,i=this.spec.attr("data-save-flags");if((!i)||i.indexOf("silentErrors")===-1){l=$axel.oppidum.parseError(m,j,k);$axel.error(l)}else{this.spec.trigger("axel-network-error",{xhr:m,status:j,e:k})}$axel.command.getEditor(this.key).trigger("axel-save-error",this,m);h(this)}function b(j){var i=j.spec.attr("data-save-flags");if(i&&i.indexOf("disableOnSave")!=-1){j.spec.attr("disabled","disable")}j.spec.addClass("axel-save-running")}function h(j){var i=j.spec.attr("data-save-flags");if(i&&i.indexOf("disableOnSave")!=-1){j.spec.removeAttr("disabled")}j.spec.removeClass("axel-save-running")}return{execute:function(k){var j,u,m,n,p,o,q,s=this,i=true,r=$axel.command.getEditor(this.key),l=this.spec.attr("data-save-confirm"),t=this.spec.attr("data-type");if(r){if(!l||confirm(l)){url=this.spec.attr("data-src")||r.attr("data-src")||".";if(url){if(r.attr("data-validation-output")||this.spec.attr("data-validation-output")){p=$axel(r.spec.get(0));i=$axel.binding.validate(p,r.attr("data-validation-output")||this.spec.attr("data-validation-output"),this.doc,r.attr("data-validation-label")||this.spec.attr("data-validation-label"))}if(i){n=r.serializeData();if(n){j=r.attr("data-method")||this.spec.attr("data-method")||"post";m=r.attr("data-transaction")||this.spec.attr("data-transaction");if(m){url=url+"?transaction="+m}url=$axel.resolveUrl(url,this.spec.get(0));b(this);$axel.command.getEditor(this.key).trigger("axel-save",this);q={url:url,payload:n,method:j};o=function(w,x,v){e.call(s,w,x,v,q)};$.ajax({url:url,type:j,data:n,dataType:t||"xml",cache:false,timeout:50000,contentType:"application/xml; charset=UTF-8",success:o,error:$.proxy(d,this)});r.hasBeenSaved=true}else{$axel.error(xtiger.util.getLocaleString("editorEmpty"))}}}else{$axel.error(xtiger.util.getLocaleString("noTargetURL"))}}}else{$axel.error(xtiger.util.getLocaleString("editorNotFound"))}}}}());$axel.command.register("save",a,{check:false})}());(function(){function a(c,d){var b=$(d);this.key=c;this.formid=b.attr("data-form");if(this.formid&&($("form#"+this.formid).length>0)){d.disabled=false;b.bind("click",$.proxy(this,"execute"))}else{d.disabled=true;$axel.error('Missing or invalid data-form attribute in submit command ("'+this.formid+'")')}}a.prototype={execute:function(){var c=$("#"+this.formid),e=$("#"+this.formid+' > input[name="data"]'),b=$axel.command.getEditor(this.key);if(b&&(c.length>0)&&(e.length>0)){e.val(b.serializeData());c.submit()}else{$axel.error("Missing editor or malformed form element to submit data")}}};$axel.command.register("submit",a,{check:true})}());(function(){function a(b,c){this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(b){$axel.command.getEditor(this.key).trigger(this.spec.attr("data-trigger-event"),this)}};$axel.command.register("trigger",a,{check:false})}());(function(a){a.addLocale("en",{errFormRequired:function(b){return"You must fill the following fields : "+b.fields},errFormInvalid:function(b){return"You must correct the following fields : "+b.fields},hintMinInputSize:function(b){return"Type at least "+b.n+" letter"+(b.n===1?"":"s")},errServerResponse:function(b){return"Unexpected response from server ("+b.xhr?b.xhr.status:"undefined). The action may have failed"},errServerTimeOut:"Action aborted: server is taking too much time to answer. You should reload the page to check if the action has been executed anyway",msgRedirect:"You are going to be redirected",editorEmpty:"The document contains no data",noTargetURL:"The command does not know where to send the data",editorNotFound:"There is no editor associated with this command"})}($axel));(function(a){a.addLocale("fr",{errFormRequired:function(b){return"Vous devez remplir les champs suivants : "+b.fields},errFormInvalid:function(b){return"Vous devez corriger les champs suivants : "+b.fields},hintMinInputSize:function(b){return"Entrez au moins "+b.n+" caractère"+(b.n===1?"":"s")},errServerResponse:function(b){return"Mauvaise réponse du serveur ("+b.xhr?b.xhr.status:"undefined). L'action a peut-être échoué"},errServerTimeOut:"Action annulée, délai de réponse dépassé. Rechargez la page pour vérifier si votre action a été prise en compte.",msgRedirect:"Vous allez être redirigé",editorEmpty:"Le document est vide",noTargetURL:"La commande ne sait pas où envoyer les données",editorNotFound:"Il n'y a pas d'éditeur associé avec cette commande"})}($axel));